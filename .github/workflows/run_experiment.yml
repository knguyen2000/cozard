name: Run Experiment on Existing Slice

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manual

jobs:
  run-experiment:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install FABRIC Client
        run: |
          sudo apt-get update
          sudo apt-get install -y libopencv-dev python3-opencv gstreamer1.0-tools gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly
          python -m pip install --upgrade pip
          pip install fabrictestbed-extensions pandas pyjwt matplotlib
          pip install -r requirements.txt

      - name: Configure FABRIC Credentials
        env:
          FABRIC_TOKEN_JSON: ${{ secrets.FABRIC_TOKEN_JSON }}
          FABRIC_BASTION_KEY: ${{ secrets.FABRIC_BASTION_KEY }}
          FABRIC_SLICE_KEY: ${{ secrets.FABRIC_SLICE_KEY }}
          FABRIC_SLICE_PUB_KEY: ${{ secrets.FABRIC_SLICE_PUB_KEY }}
        run: |
          mkdir -p ~/.fabric
          python -c "import os; open(os.path.expanduser('~/.fabric/id_token.json'), 'w').write(os.environ['FABRIC_TOKEN_JSON'])"
          python -c "import os; open(os.path.expanduser('~/.fabric/bastion_key'), 'w').write(os.environ['FABRIC_BASTION_KEY'])"
          python -c "import os; open(os.path.expanduser('~/.fabric/slice_key'), 'w').write(os.environ['FABRIC_SLICE_KEY'])"
          python -c "import os; open(os.path.expanduser('~/.fabric/slice_key.pub'), 'w').write(os.environ['FABRIC_SLICE_PUB_KEY'])"
          chmod 600 ~/.fabric/bastion_key ~/.fabric/slice_key

      - name: Create FABRIC Configuration
        run: |
          cat <<EOF > fabric_rc
          [DEFAULT]
          FABRIC_CREDMGR_HOST=cm.fabric-testbed.net
          FABRIC_ORCHESTRATOR_HOST=orchestrator.fabric-testbed.net
          FABRIC_PROJECT_ID=${{ secrets.FABRIC_PROJECT_ID }}
          FABRIC_TOKEN_LOCATION=/home/runner/.fabric/id_token.json
          FABRIC_BASTION_HOST=bastion.fabric-testbed.net
          FABRIC_BASTION_USERNAME=${{ secrets.FABRIC_BASTION_USERNAME }}
          FABRIC_BASTION_KEY_LOCATION=/home/runner/.fabric/bastion_key
          FABRIC_SLICE_PRIVATE_KEY_FILE=/home/runner/.fabric/slice_key
          FABRIC_SLICE_PUBLIC_KEY_FILE=/home/runner/.fabric/slice_key.pub
          EOF

      - name: Run Experiment (No Provisioning)
        env:
          FABRIC_LOG_LEVEL: INFO
          FABRIC_RC_FILE: ${{ github.workspace }}/fabric_rc
        run: |
          echo "Running experiment on existing slice..."
          echo "This assumes slice 'cloud_gaming_experiment' already exists"
          python scripts/run_experiment_only.py

      - name: Generate Performance Graphs
        if: always()
        run: |
          echo "Running visualization script..."
          python3 scripts/plot_results.py

      - name: Upload Experiment Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: experiment-results-${{ github.run_number }}
          path: |
            gaming_metrics.csv
            metrics_*.csv
            chart_*.png
            *.log
          retention-days: 30

      - name: Create Summary
        if: always()
        run: |
          echo "## Experiment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Slice**: Reused existing infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "**Runtime**: ~1-2 minutes (no provisioning)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f gaming_metrics.csv ]; then
            echo "Results collected successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "No results file found" >> $GITHUB_STEP_SUMMARY
          fi
