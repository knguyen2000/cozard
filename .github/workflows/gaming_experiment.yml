name: Cloud Gaming Kill-Switch Experiment

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: "0 2 * * 0" # Weekly on Sunday at 2 AM UTC (optional)

jobs:
  gaming-experiment:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install FABRIC Client
        run: |
          python -m pip install --upgrade pip
          pip install fabrictestbed-extensions pandas pyjwt

      - name: Configure FABRIC Credentials
        env:
          FABRIC_TOKEN_JSON: ${{ secrets.FABRIC_TOKEN_JSON }}
          FABRIC_BASTION_KEY: ${{ secrets.FABRIC_BASTION_KEY }}
          FABRIC_SLICE_KEY: ${{ secrets.FABRIC_SLICE_KEY }}
          FABRIC_SLICE_PUB_KEY: ${{ secrets.FABRIC_SLICE_PUB_KEY }}
        run: |
          mkdir -p ~/.fabric
          python -c "import os; open(os.path.expanduser('~/.fabric/id_token.json'), 'w').write(os.environ['FABRIC_TOKEN_JSON'])"
          python -c "import os; open(os.path.expanduser('~/.fabric/bastion_key'), 'w').write(os.environ['FABRIC_BASTION_KEY'])"
          python -c "import os; open(os.path.expanduser('~/.fabric/slice_key'), 'w').write(os.environ['FABRIC_SLICE_KEY'])"
          python -c "import os; open(os.path.expanduser('~/.fabric/slice_key.pub'), 'w').write(os.environ['FABRIC_SLICE_PUB_KEY'])"
          chmod 600 ~/.fabric/bastion_key ~/.fabric/slice_key

      - name: Create FABRIC Configuration
        run: |
          cat <<EOF > fabric_rc
          [DEFAULT]
          FABRIC_CREDMGR_HOST=cm.fabric-testbed.net
          FABRIC_ORCHESTRATOR_HOST=orchestrator.fabric-testbed.net
          FABRIC_PROJECT_ID=${{ secrets.FABRIC_PROJECT_ID }}
          FABRIC_TOKEN_LOCATION=/home/runner/.fabric/id_token.json
          FABRIC_BASTION_HOST=bastion.fabric-testbed.net
          FABRIC_BASTION_USERNAME=${{ secrets.FABRIC_BASTION_USERNAME }}
          FABRIC_BASTION_KEY_LOCATION=/home/runner/.fabric/bastion_key
          FABRIC_SLICE_PRIVATE_KEY_FILE=/home/runner/.fabric/slice_key
          FABRIC_SLICE_PUBLIC_KEY_FILE=/home/runner/.fabric/slice_key.pub
          EOF

      - name: Run Cloud Gaming Experiment
        env:
          FABRIC_LOG_LEVEL: INFO
          FABRIC_RC_FILE: ${{ github.workspace }}/fabric_rc
        run: |
          echo "Starting Cloud Gaming Kill-Switch Experiment..."
          echo "This will provision 4 FABRIC nodes and run WebRTC + BBRv3 competition test"
          python scripts/run_gaming_experiment.py

      - name: Generate Performance Graphs
        if: always()
        run: |
          # Install matplotlib for visualization
          pip install matplotlib pandas

          # Create visualization script
          cat <<'PYEOF' > analyze_results.py
          import pandas as pd
          import matplotlib.pyplot as plt

          try:
              df = pd.read_csv('baseline.csv')
              
              fig, axes = plt.subplots(3, 1, figsize=(12, 10))
              
              # FPS over time
              axes[0].plot(df['elapsed_sec'], df['fps'], color='blue', linewidth=1)
              axes[0].set_xlabel('Time (seconds)')
              axes[0].set_ylabel('FPS')
              axes[0].set_title('Video Frame Rate Over Time')
              axes[0].grid(True, alpha=0.3)
              axes[0].axhline(y=30, color='green', linestyle='--', label='Target 30 FPS')
              axes[0].legend()
              
              # Stall events
              stalls = df[df['is_stall'] == 1]
              axes[1].scatter(stalls['elapsed_sec'], stalls['delta_ms'], 
                            color='red', alpha=0.6, s=50)
              axes[1].set_xlabel('Time (seconds)')
              axes[1].set_ylabel('Stall Duration (ms)')
              axes[1].set_title('Stall Events (>100ms frame gaps)')
              axes[1].grid(True, alpha=0.3)
              axes[1].axhline(y=100, color='orange', linestyle='--', label='Stall Threshold')
              axes[1].legend()
              
              # Bitrate
              axes[2].plot(df['elapsed_sec'], df['bitrate_kbps'], color='purple', linewidth=1)
              axes[2].set_xlabel('Time (seconds)')
              axes[2].set_ylabel('Bitrate (kbps)')
              axes[2].set_title('Video Stream Bitrate')
              axes[2].grid(True, alpha=0.3)
              
              plt.tight_layout()
              plt.savefig('gaming_performance.png', dpi=150, bbox_inches='tight')
              print("✓ Generated gaming_performance.png")
              
              # Summary statistics
              print("\n=== PERFORMANCE SUMMARY ===")
              print(f"Average FPS: {df['fps'].mean():.1f}")
              print(f"Min FPS: {df['fps'].min():.1f}")
              print(f"Stall events: {len(stalls)}")
              print(f"Total stall time: {stalls['delta_ms'].sum():.0f} ms")
              print(f"Average bitrate: {df['bitrate_kbps'].mean():.0f} kbps")
              
          except Exception as e:
              print(f"Error generating graphs: {e}")
          PYEOF

          python analyze_results.py

      - name: Upload Experiment Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cloud-gaming-results-${{ github.run_number }}
          path: |
            baseline.csv
            gaming_performance.png
            slice_details.json
            *.log
          retention-days: 30

      - name: Create Summary Report
        if: always()
        run: |
          echo "## Cloud Gaming Kill-Switch Experiment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Experiment:** WebRTC Cloud Gaming vs BBRv3 Download Competition" >> $GITHUB_STEP_SUMMARY
          echo "**Hardware:** Tesla T4 GPU with NVENC encoding" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f baseline.csv ]; then
            echo "✓ Performance data collected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download artifacts to analyze:" >> $GITHUB_STEP_SUMMARY
            echo "- \`baseline.csv\`: Frame-by-frame performance metrics" >> $GITHUB_STEP_SUMMARY
            echo "- \`gaming_performance.png\`: Visualization graphs" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No performance data collected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup FABRIC Slice
        if: always()
        env:
          FABRIC_LOG_LEVEL: INFO
          FABRIC_RC_FILE: ${{ github.workspace }}/fabric_rc
        run: |
          python -c "
          from fabrictestbed_extensions.fablib.fablib import FablibManager as fablib_manager
          try:
              fablib = fablib_manager()
              slice = fablib.get_slice('cloud_gaming_experiment')
              print('Deleting FABRIC slice...')
              slice.delete()
              print('✓ Cleanup complete')
          except Exception as e:
              print(f'Cleanup note: {e}')
          "
